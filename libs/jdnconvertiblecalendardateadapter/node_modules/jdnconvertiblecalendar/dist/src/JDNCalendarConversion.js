import { CalendarDate } from './CalendarDate';
export var JDNConvertibleConversionModule;
(function (JDNConvertibleConversionModule) {
    /**
     * Removes the fraction from a given number (<https://stackoverflow.com/questions/4912788/truncate-not-round-off-decimal-numbers-in-javascript/9232092#9232092>).
     * This also works for negative numbers.
     *
     * 1.2 -> 1
     * -3.2 -> -3
     *
     * @param num the number whose fraction is to be removed.
     * @returns given number without fractions.
     */
    var truncateDecimals = function (num) {
        return Math[num < 0 ? 'ceil' : 'floor'](num);
    };
    /**
     * Converts a Gregorian calendar date to a JDC.
     *
     * Conversion algorithm from:
     * Jean Meeus, Astronomical Algorithms, 1998, 60pp.
     *
     * There is a year 0.
     *
     * @param calendarDate Gregorian calendar date to be converted to JDC.
     * @returns the JDC representing the given Gregorian calendar date.
     */
    JDNConvertibleConversionModule.gregorianToJDC = function (calendarDate) {
        var year = 0;
        var month = 0;
        var day = calendarDate.day;
        if (calendarDate.daytime !== undefined) {
            day = day + calendarDate.daytime;
        }
        if (calendarDate.month > 2) {
            year = calendarDate.year;
            month = calendarDate.month;
        }
        else {
            year = calendarDate.year - 1;
            month = calendarDate.month + 12;
        }
        var b = 0;
        var a = truncateDecimals(year / 100.);
        var idate = year * 10000 + month * 100 + day;
        // check whether given date is before October 15th, 1582 (see README)
        if (idate >= 15821015) {
            b = 2 - a + truncateDecimals(a / 4.);
        }
        else {
            b = 0;
        }
        var jdc = truncateDecimals(365.25 * (year + 4716)) +
            truncateDecimals(30.6001 * (month + 1)) +
            day + b - 1524.5;
        return jdc;
    };
    /**
     * Converts a Gregorian calendar date to a JDN.
     *
     * @param calendarDate Gregorian calendar date to be converted to JDN.
     * @returns the JDN representing the given Gregorian calendar date.
     */
    JDNConvertibleConversionModule.gregorianToJDN = function (calendarDate) {
        var jdc = JDNConvertibleConversionModule.gregorianToJDC(calendarDate);
        /*

        Converts JDC to JDN by adding 0.5 and getting rid of fractions.

        2446822.5 up to 2446823.49… (JDCs for January 27th 1987) -> 2446823 (JDN for January 27th 1987)

         */
        return truncateDecimals(jdc + 0.5);
    };
    /**
     * Converts a JDC to a Gregorian Calendar date.
     *
     * Conversion algorithm from:
     * Jean Meeus, Astronomical Algorithms, 1998, 63pp.
     *
     * There is a year 0.
     *
     * @param jdc JDC to be converted to a Gregorian calendar date.
     * @returns the Gregorian calendar date created from the given JDC.
     */
    JDNConvertibleConversionModule.JDCToGregorian = function (jdc) {
        jdc = jdc + 0.5;
        var z = truncateDecimals(jdc);
        var f = jdc - z;
        var alpha = truncateDecimals((z - 1867216.25) / 36524.25);
        var a = z + 1 + alpha - truncateDecimals(alpha / 4.);
        var b = a + 1524;
        var c = truncateDecimals((b - 122.1) / 365.25);
        var d = truncateDecimals(365.25 * c);
        var e = truncateDecimals((b - d) / 30.6001);
        var day = b - d - truncateDecimals(30.6001 * e) + f;
        var month;
        if (e < 14) {
            month = e - 1;
        }
        else {
            month = e - 13;
        }
        var year;
        if (month > 2) {
            year = c - 4716;
        }
        else {
            year = c - 4715;
        }
        var fullday = truncateDecimals(day);
        var daytime = day - fullday;
        return new CalendarDate(year, month, fullday, undefined, daytime);
    };
    /**
     * Converts a JDN to a Gregorian calendar date.
     *
     * @param jdn the given JDN.
     * @returns the Gregorian calendar date created from the given JDN.
     */
    JDNConvertibleConversionModule.JDNToGregorian = function (jdn) {
        return JDNConvertibleConversionModule.JDCToGregorian(jdn);
    };
    /**
     * Converts a Julian calendar date to a JDC.
     *
     * Conversion algorithm from:
     * Jean Meeus, Astronomical Algorithms, 1998, 60pp.
     *
     * There is a year 0.
     *
     * @param calendarDate Julian calendar date to be converted to JDC.
     * @returns JDC representing the given Julian calendar date.
     */
    JDNConvertibleConversionModule.julianToJDC = function (calendarDate) {
        // TODO: check validity of given calendar date
        var year = 0;
        var month = 0;
        var day = calendarDate.day;
        if (calendarDate.daytime !== undefined) {
            day = day + calendarDate.daytime;
        }
        if (calendarDate.month > 2) {
            year = calendarDate.year;
            month = calendarDate.month;
        }
        else {
            year = calendarDate.year - 1;
            month = calendarDate.month + 12;
        }
        var c = 0;
        if (year < 0) {
            c = -0.75;
        }
        var jdc = truncateDecimals(365.25 * year + c) +
            truncateDecimals(30.6001 * (month + 1)) + day + 1720994.5;
        return jdc;
    };
    /**
     * Converts a Julian calendar date to a JDN.
     *
     * @param calendarDate Julian calendar date to be converted to JDN.
     * @returns JDN representing the given Julian calendar date.
     */
    JDNConvertibleConversionModule.julianToJDN = function (calendarDate) {
        // TODO: check validity of given calendar date
        var jdc = JDNConvertibleConversionModule.julianToJDC(calendarDate);
        /*

        Converts JDC to JDN by adding 0.5 and getting rid of fractions.

        2446822.5 up to 2446823.49… (JDCs for January 14th 1987) -> 2446823 (JDN for January 14th 1987)

         */
        return truncateDecimals(jdc + 0.5); // adaption because full number without fraction of JDC represents noon.
    };
    /**
     * Converts a JDC to a Julian Calendar date.
     *
     * Conversion algorithm from:
     * Jean Meeus, Astronomical Algorithms, 1998, 63pp.
     *
     * There is a year 0.
     *
     * @param jdc JDC to be converted to a Julian calendar date.
     * @returns Julian calendar date created from given JDC.
     */
    JDNConvertibleConversionModule.JDCToJulian = function (jdc) {
        jdc = jdc + 0.5;
        var z = truncateDecimals(jdc);
        var f = jdc - z;
        var a = z; // it's a julian calendar
        var b = a + 1524;
        var c = truncateDecimals((b - 122.1) / 365.25);
        var d = truncateDecimals(365.25 * c);
        var e = truncateDecimals((b - d) / 30.6001);
        var day = b - d - truncateDecimals(30.6001 * e) + f;
        var month;
        if (e < 14) {
            month = e - 1;
        }
        else {
            month = e - 13;
        }
        var year;
        if (month > 2) {
            year = c - 4716;
        }
        else {
            year = c - 4715;
        }
        var fullday = truncateDecimals(day);
        var daytime = day - fullday;
        return new CalendarDate(year, month, fullday, undefined, daytime);
    };
    /**
     * Converts a JDN to a Julian calendar date.
     *
     * @param jdn JDN to be converted to a Julian calendar date.
     * @returns Julian calendar date created from given JDN.
     */
    JDNConvertibleConversionModule.JDNToJulian = function (jdn) {
        return JDNConvertibleConversionModule.JDCToJulian(jdn);
    };
    /**
     * Determine the day of week from the given JDN. Works only for calendars which use
     * the 7 day week with Sunday to Saturday.
     *
     * Algorithm from:
     * Jean Meeus: Astronomical Algorithms, 1998, p. 65.
     *
     * @param jdc given JDC.
     * @returns the number of the day of the week for the given JDC (0 Sunday, 1 Monday, 2 Tuesday, 3 Wednesday, 4 Thursday, 5 Friday, 6 Saturday).
     */
    JDNConvertibleConversionModule.dayOfWeekFromJDC = function (jdc) {
        return truncateDecimals(jdc + 1.5) % 7;
    };
    /**
     * Converts an Islamic calendar date to a JDC.
     *
     * Algorithm from:
     * Jean Meeus, Astronomical Algorithms, 1998, 73pp.
     *
     * The first day of the Islamic calendar according to this algorithm is July 16th, 622 CE (Julian; JDC = 1948439.5).
     * This is in agreement with the widely used tables of Wuestenfeld et al., Wuestenfeld-Mahler'sche
     * Vergleichungs-Tabellen zur muslimischen und iranischen Zeitrechnung, 1961. However, it is well known that
     * these calendar dates may be off by 1 to 2 days in comparison to the calendar that was actually used, especially
     * if historical dates are concerned. There are two more points of concern: Sura 9, 36-37 of the Koran
     * suggests that a lunar calendar without intercalation was applied from year 10 of the Hijra onwards only; earlier
     * on, probably a luni-solar calendar was used. This algorithm assumes that a lunar calendar without any
     * intercalation started in year 1 of the Hijra. Secondly, in many countries the first actual sighting of the lunar
     * crescent was decisive for the beginning of a new month up to quite recent times, but not a regular scheme. This
     * introduces a dependency on the location: a new Islamic calendar month may have started on different days in
     * different locations.
     * Unambiguous conversion of historical Islamic dates into Julian or Gregorian calendar dates or vice cersa can
     * only be achieved if the day of the week is known in addition.
     *
     * @param calendarDate Islamic calendar date to be converted to JDC.
     * @returns JDC representing the given Islamic calendar date.
     */
    JDNConvertibleConversionModule.islamicToJDC = function (calendarDate) {
        var h = calendarDate.year;
        var m = calendarDate.month;
        var d = calendarDate.day;
        if (calendarDate.daytime !== undefined) {
            d = d + calendarDate.daytime;
        }
        var n = d + Math.floor(29.5001 * (m - 1) + 0.99);
        var q = Math.floor(h / 30);
        var r = h % 30;
        if (r < 0) {
            r = r + 30;
        }
        var a = Math.floor((11 * r + 3) / 30);
        var w = 404 * q + 354 * r + 208 + a;
        var q1 = Math.floor(w / 1461);
        var q2 = w % 1461;
        if (q2 < 0) {
            q2 = q2 + 1461;
        }
        var g = 621 + 4 * Math.floor(7 * q + q1);
        var k = Math.floor(q2 / 365.2422);
        var e = Math.floor(365.2422 * k);
        var j = q2 - e + n - 1;
        var x = g + k;
        if (j > 366 && (x % 4 == 0)) {
            j = j - 366;
            x = x + 1;
        }
        else if (j > 365 && (x % 4 > 0)) {
            j = j - 365;
            x = x + 1;
        }
        var jdc = truncateDecimals(365.25 * (x - 1)) + 1721423 + j - 0.5;
        return jdc;
    };
    /**
     * Converts an Islamic calendar date to a JDN.
     *
     * @param calendarDate Islamic calendar date to be converted to JDN.
     * @returns JDN representing the given Islamic calendar date.
     */
    JDNConvertibleConversionModule.islamicToJDN = function (calendarDate) {
        var jdc = JDNConvertibleConversionModule.islamicToJDC(calendarDate);
        return truncateDecimals(jdc + 0.5); // adaption because full number without fraction of JDC represents noon.
    };
    /**
     * Converts a JDC to an Islamic calendar date.
     *
     * Algorithm from:
     * Jean Meeus, Astronomical Algorithms, 1998, 75pp.
     *
     * The first day of the Islamic calendar according to this algorithm is July 16th, 622 CE (Julian; JDC = 1948439.5).
     * This is in agreement with the widely used tables of Wuestenfeld et al., Wuestenfeld-Mahler'sche
     * Vergleichungs-Tabellen zur muslimischen und iranischen Zeitrechnung, 1961. However, it is well known that
     * these calendar dates may be off by 1 to 2 days in comparison to the calendar that was actually used, especially
     * if historical dates are concerned. There are two more points of concern: Sura 9, 36-37 of the Koran
     * suggests that a lunar calendar without intercalation was applied from year 10 of the Hijra onwards only; earlier
     * on, probably a luni-solar calendar was used. This algorithm assumes that a lunar calendar without any
     * intercalation started in year 1 of the Hijra. Secondly, in many countries the first actual sighting of the lunar
     * crescent was decisive for the beginning of a new month up to quite recent times, but not a regular scheme. This
     * introduces a dependency on the location: a new Islamic calendar month may have started on different days in
     * different locations.
     * Unambiguous conversion of historical Islamic dates into Julian or Gregorian calendar dates or vice cersa can
     * only be achieved if the day of the week is known in addition.
     *
     * @param jdc JDC to be converted to an Islamic calendar date.
     * @returns Islamic calendar date created from given JDC.
     */
    JDNConvertibleConversionModule.JDCToIslamic = function (jdc) {
        // convert given JDC into a Julian calendar date
        var julianCalendarDate = JDNConvertibleConversionModule.JDCToJulian(jdc);
        var x = julianCalendarDate.year;
        var m = julianCalendarDate.month;
        var d = julianCalendarDate.day;
        var w;
        if ((x % 4) == 0) {
            w = 1;
        }
        else {
            w = 2;
        }
        var n = truncateDecimals((275 * m) / 9) - w * truncateDecimals((m + 9) / 12) + d - 30;
        var a = x - 623;
        var b = Math.floor(a / 4);
        var c = a / 4 - b;
        c = Math.floor(c * 4);
        var c1 = 365.2501 * c;
        var c2 = Math.floor(c1);
        if ((c1 - c2) > 0.5) {
            c2 = c2 + 1;
        }
        var d_ = 1461 * b + 170 + c2;
        var q = Math.floor(d_ / 10631);
        var r = d_ % 10631;
        if (r < 0) {
            r = r + 10631;
        }
        var j = Math.floor(r / 354);
        var k = r % 354;
        if (k < 0) {
            k = k + 354;
        }
        var o = Math.floor((11 * j + 14) / 30);
        var h = 30 * q + j + 1;
        var jj = k - o + n - 1;
        if (jj > 354) {
            var cl = h % 30;
            if (cl < 0) {
                cl = cl + 30;
            }
            var dl = (11 * cl + 3) % 30;
            if (dl < 0) {
                dl = dl + 30;
            }
            if (dl < 19) {
                jj = jj - 354;
                h = h + 1;
            }
            if (dl > 18) {
                jj = jj - 355;
                h = h + 1;
            }
            if (jj == 0) {
                jj = 355;
                h = h - 1;
            }
        }
        var s = Math.floor((jj - 1) / 29.5);
        m = 1 + s;
        d = Math.floor(jj - 29.5 * s);
        if (jj == 355) {
            m = 12;
            d = 30;
        }
        return new CalendarDate(h, m, d, undefined, julianCalendarDate.daytime);
    };
    /**
     * Converts a JDN to an Islamic calendar date.
     *
     * @param jdn JDN to be converted to an Islamic calendar date.
     * @returns @returns Islamic calendar date created from given JDN.
     */
    JDNConvertibleConversionModule.JDNToIslamic = function (jdn) {
        return JDNConvertibleConversionModule.JDCToIslamic(jdn);
    };
})(JDNConvertibleConversionModule || (JDNConvertibleConversionModule = {}));
